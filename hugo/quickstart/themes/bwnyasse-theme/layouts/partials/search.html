<div x-data="search()" @keydown.window.prevent.cmd.k.exact="showSearch()"
    @keydown.window.prevent.ctrl.k.exact="showSearch()">
    <!-- Search Trigger Button -->
    <button @click="showSearch()"
        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <span class="hidden sm:inline">Search</span>
        <span class="hidden sm:inline text-sm text-gray-400">(Ctrl K)</span>
    </button>

    <!-- Search Modal -->
    <div x-show="isOpen" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">

        <!-- Overlay -->
        <div class="fixed inset-0 bg-black/50" @click="hideSearch()"></div>

        <!-- Modal -->
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white dark:bg-gray-800 w-full max-w-2xl rounded-xl shadow-2xl"
                @click.away="hideSearch()">

                <!-- Search Input -->
                <div class="p-4 border-b dark:border-gray-700">
                    <div class="relative">
                        <input type="text" x-ref="searchInput" x-model="searchQuery"
                            @input.debounce.300ms="performSearch()" placeholder="Search posts..."
                            class="w-full px-4 py-3 pl-12 rounded-lg bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>

                <!-- Results list -->
                <div class="space-y-8">
                    <template x-for="result in searchResults" :key="result.permalink">
                        <article class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                            <div class="flex gap-2 mb-3">
                                <template x-for="category in result.categories" :key="category">
                                    <span class="text-xs bg-secondary/20 text-dark dark:text-white px-2 py-1 rounded"
                                        x-text="category"></span>
                                </template>
                            </div>
                            <h2 class="text-xl font-semibold mb-2">
                                <a :href="result.permalink" x-text="result.title"
                                    class="hover:text-primary transition-colors"></a>
                            </h2>
                            <!-- Use textContent to properly display formatted text -->
                            <p class="text-gray-600 dark:text-gray-300 mb-4"
                                x-text="result.summary.length > 200 ? result.summary.substring(0, 200) + '...' : result.summary">
                            </p>
                            <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                                <span x-text="result.date"></span>
                                <a :href="result.permalink"
                                    class="text-primary hover:text-primary/80 transition-colors">
                                    Read More â†’
                                </a>
                            </div>
                        </article>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
    function search() {
        return {
            searchQuery: '',
            searchResults: [],
            fuse: null,
            searchIndex: [],

            async init() {
                const urlParams = new URLSearchParams(window.location.search);
                this.searchQuery = urlParams.get('q') || '';

                try {
                    const response = await fetch('/index.json');
                    this.searchIndex = await response.json();

                    // Initialize Fuse.js with better content handling
                    this.fuse = new Fuse(this.searchIndex, {
                        keys: [
                            {
                                name: 'title',
                                weight: 0.8
                            },
                            {
                                name: 'content',
                                weight: 0.5
                            },
                            {
                                name: 'summary',
                                weight: 0.7
                            },
                            {
                                name: 'categories',
                                weight: 0.3
                            },
                            {
                                name: 'tags',
                                weight: 0.3
                            }
                        ],
                        includeScore: true,
                        threshold: 0.4,
                        ignoreLocation: true,
                        useExtendedSearch: true
                    });

                    if (this.searchQuery) {
                        this.performSearch();
                    }
                } catch (error) {
                    console.error('Error loading search index:', error);
                }
            },

            performSearch() {
                if (!this.searchQuery) {
                    this.searchResults = [];
                    return;
                }

                const results = this.fuse.search(this.searchQuery);
                this.searchResults = results.map(result => {
                    return {
                        ...result.item,
                        // Clean up the summary
                        summary: result.item.summary
                            .replace(/(<([^>]+)>)/gi, '') // Remove HTML tags
                            .replace(/&nbsp;/g, ' ')      // Replace &nbsp; with spaces
                            .replace(/\s+/g, ' ')         // Normalize whitespace
                            .trim()
                    };
                });

                const url = new URL(window.location);
                url.searchParams.set('q', this.searchQuery);
                window.history.pushState({}, '', url);
            }
        }
    }
</script>